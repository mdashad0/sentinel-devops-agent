name: Lint & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        cd sentinel-frontend
        npm install
    
    - name: Run ESLint
      run: |
        cd sentinel-frontend
        npm run lint 2>&1 || true
    
    - name: Check TypeScript
      run: |
        cd sentinel-frontend
        npx tsc --noEmit 2>&1 || true

  lint-backend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        cd backend
        npm install
    
    - name: Syntax check
      run: |
        cd backend
        node -c index.js

  lint-cli:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        cd cli
        npm install
    
    - name: Syntax check
      run: |
        cd cli
        node -c index.js

  docker-build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build services
      run: |
        docker compose build --no-cache

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Run npm audit
      run: |
        cd sentinel-frontend && npm audit --audit-level=moderate || true
        cd ../backend && npm audit --audit-level=moderate || true
        cd ../cli && npm audit --audit-level=moderate || true

  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check markdown files
      run: |
        # Basic markdown validation
        find . -name "*.md" -not -path "./node_modules/*" | head -20

  notify:
    needs: [lint-frontend, lint-backend, lint-cli, docker-build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check results
      run: |
        if [ "${{ needs.lint-frontend.result }}" = "failure" ] || \
           [ "${{ needs.lint-backend.result }}" = "failure" ] || \
           [ "${{ needs.lint-cli.result }}" = "failure" ]; then
          echo "⚠️ Some checks failed"
          exit 1
        fi
        echo "✅ All checks passed!"
